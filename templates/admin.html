<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nova â€” Admin Dashboard</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Courier New',Courier,monospace;background:#fff;color:#222;padding:20px}
h1{font-size:1.6rem;margin-bottom:4px}
h1 b{color:#4a3fc0}
.sub{color:#888;font-size:.85rem;margin-bottom:20px}

/* Tabs */
.tabs{display:flex;gap:0;border-bottom:2px solid #ddd;margin-bottom:20px}
.tab{padding:10px 20px;cursor:pointer;font:inherit;font-size:14px;font-weight:600;border:none;background:none;color:#888;border-bottom:2px solid transparent;margin-bottom:-2px}
.tab:hover{color:#222}
.tab.active{color:#4a3fc0;border-bottom-color:#4a3fc0}
.tab-content{display:none}
.tab-content.active{display:block}

/* Stats grid */
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:28px}
.card{background:#f9f9f9;border:1px solid #eee;border-radius:8px;padding:16px;text-align:center}
.card .num{font-size:2rem;font-weight:bold;color:#1a9}
.card .label{font-size:.75rem;color:#888;text-transform:uppercase;letter-spacing:.5px;margin-top:4px}
.card.warn .num{color:#c90}
.card.info .num{color:#4a3fc0}
.card.purple .num{color:#9333ea}

/* Live dot */
.live{display:inline-block;width:8px;height:8px;background:#1a9;border-radius:50%;margin-right:6px;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* Table */
.table-wrap{overflow-x:auto;margin-top:8px}
table{width:100%;border-collapse:collapse;font-size:.8rem}
th{text-align:left;padding:8px 10px;border-bottom:2px solid #ddd;color:#888;text-transform:uppercase;font-size:.7rem;letter-spacing:.5px}
td{padding:6px 10px;border-bottom:1px solid #f0f0f0}
tr:hover td{background:#f5f5ff}

/* Action badges */
.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:.7rem;font-weight:bold}
.badge-login{background:#e0f2fe;color:#0284c7}
.badge-signup{background:#dcfce7;color:#16a34a}
.badge-connect{background:#e0f2fe;color:#2563eb}
.badge-disconnect{background:#f5f5f4;color:#78716c}
.badge-match{background:#f3e8ff;color:#9333ea}
.badge-skip{background:#fef9c3;color:#a16207}
.badge-queue{background:#f1f5f9;color:#64748b}
.badge-logout{background:#fae8ff;color:#a855f7}
.badge-chat_end{background:#fee2e2;color:#dc2626}

/* Search */
.search-bar{display:flex;gap:8px;margin-bottom:16px}
.search-bar input{flex:1;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font:inherit;font-size:14px;outline:none}
.search-bar input:focus{border-color:#4a3fc0}
.search-bar button{padding:8px 16px;border:none;border-radius:8px;background:#4a3fc0;color:#fff;font:inherit;font-size:13px;font-weight:600;cursor:pointer}
.search-bar button:hover{opacity:.9}

/* User row */
.user-row{display:flex;align-items:center;gap:10px}
.user-row img{width:28px;height:28px;border-radius:50%;flex-shrink:0}
.user-row .no-avatar{width:28px;height:28px;border-radius:50%;background:#eee;display:flex;align-items:center;justify-content:center;font-size:12px;color:#888;flex-shrink:0}

/* Delete button */
.btn-del{padding:4px 10px;border:1px solid #d44;border-radius:6px;background:#fff;color:#d44;font:inherit;font-size:11px;font-weight:600;cursor:pointer}
.btn-del:hover{background:#d44;color:#fff}

/* Pagination */
.pagination{display:flex;align-items:center;justify-content:center;gap:12px;margin-top:16px;font-size:13px;color:#888}
.pagination button{padding:6px 14px;border:1px solid #ddd;border-radius:6px;background:#fff;font:inherit;font-size:12px;cursor:pointer}
.pagination button:hover{background:#f5f5f5}
.pagination button:disabled{opacity:.3;cursor:not-allowed}

.refresh-info{color:#aaa;font-size:.75rem;margin-top:16px;text-align:center}

/* Confirm modal */
.modal-bg{display:none;position:fixed;inset:0;background:#0005;z-index:100;align-items:center;justify-content:center}
.modal-bg.on{display:flex}
.modal{background:#fff;border-radius:12px;padding:24px;max-width:360px;width:90%;text-align:center;box-shadow:0 4px 20px #0002}
.modal h3{margin-bottom:8px;font-size:16px}
.modal p{color:#777;font-size:13px;margin-bottom:16px}
.modal .modal-btns{display:flex;gap:8px;justify-content:center}
.modal .modal-btns button{padding:8px 20px;border-radius:8px;border:none;font:inherit;font-size:13px;font-weight:600;cursor:pointer}
.modal .btn-cancel{background:#eee;color:#555}
.modal .btn-confirm{background:#d44;color:#fff}
</style>
</head>
<body>

<h1>No<b>va</b> Admin</h1>
<p class="sub"><span class="live"></span>Live dashboard â€” auto-refreshes every 3 seconds</p>

<div class="tabs">
  <button class="tab active" onclick="switchTab('stats')">ğŸ“Š Stats</button>
  <button class="tab" onclick="switchTab('users')">ğŸ‘¥ Users</button>
  <button class="tab" onclick="switchTab('logs')">ğŸ“‹ Activity</button>
</div>

<!-- Stats Tab -->
<div id="tab-stats" class="tab-content active">
  <div class="grid">
    <div class="card"><div class="num" id="s-online">â€”</div><div class="label">Online Now</div></div>
    <div class="card warn"><div class="num" id="s-queue">â€”</div><div class="label">In Queue</div></div>
    <div class="card purple"><div class="num" id="s-chat">â€”</div><div class="label">Active Chats</div></div>
    <div class="card info"><div class="num" id="s-total">â€”</div><div class="label">Total Users</div></div>
    <div class="card info"><div class="num" id="s-google">â€”</div><div class="label">Google Users</div></div>
    <div class="card info"><div class="num" id="s-email">â€”</div><div class="label">Email Users</div></div>
    <div class="card warn"><div class="num" id="s-signups">â€”</div><div class="label">Signups (24h)</div></div>
    <div class="card"><div class="num" id="s-ips">â€”</div><div class="label">Unique IPs (24h)</div></div>
  </div>
</div>

<!-- Users Tab -->
<div id="tab-users" class="tab-content">
  <div class="search-bar">
    <input type="text" id="user-search" placeholder="Search by email, name, or nicknameâ€¦">
    <button onclick="searchUsers()">Search</button>
  </div>
  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>User</th><th>Nickname</th><th>Email</th><th>Auth</th><th>Joined</th><th>Last Login</th><th></th></tr>
      </thead>
      <tbody id="user-body">
        <tr><td colspan="6" style="text-align:center;color:#aaa">Click "Users" tab to load</td></tr>
      </tbody>
    </table>
  </div>
  <div class="pagination">
    <button id="prev-page" onclick="changePage(-1)" disabled>â† Prev</button>
    <span id="page-info">Page 1</span>
    <button id="next-page" onclick="changePage(1)" disabled>Next â†’</button>
  </div>
</div>

<!-- Activity Tab -->
<div id="tab-logs" class="tab-content">
  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>Time</th><th>Action</th><th>Email</th><th>Auth</th><th>IP</th><th>Details</th></tr>
      </thead>
      <tbody id="log-body">
        <tr><td colspan="6" style="text-align:center;color:#aaa">Loadingâ€¦</td></tr>
      </tbody>
    </table>
  </div>
</div>

<p class="refresh-info">Last updated: <span id="last-update">â€”</span></p>

<!-- Delete Confirmation Modal -->
<div class="modal-bg" id="del-modal">
  <div class="modal">
    <h3>Delete User</h3>
    <p>Are you sure you want to delete <strong id="del-email"></strong>?<br>This will remove their account and all activity logs.</p>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-confirm" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<script>
function $(id){return document.getElementById(id)}

function escHtml(s){const d=document.createElement("div");d.textContent=s;return d.innerHTML}

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active"));
  event.target.classList.add("active");
  $("tab-"+name).classList.add("active");
  if(name==="users") loadUsers();
}

// â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const badgeClass={
  login:"badge-login",signup:"badge-signup",connect:"badge-connect",
  disconnect:"badge-disconnect",match:"badge-match",skip:"badge-skip",
  queue:"badge-queue",logout:"badge-logout",chat_end:"badge-chat_end",
  admin_delete_user:"badge-chat_end",
};

async function refreshStats(){
  try{
    const r=await fetch("/api/admin/stats");
    if(!r.ok) return;
    const d=await r.json();

    $("s-online").textContent=d.online;
    $("s-queue").textContent=d.in_queue;
    $("s-chat").textContent=d.in_chat;
    $("s-total").textContent=d.total_users;
    $("s-google").textContent=d.google_users;
    $("s-email").textContent=d.email_users;
    $("s-signups").textContent=d.signups_24h;
    $("s-ips").textContent=d.unique_ips_24h;

    const tbody=$("log-body");
    if(!d.recent_logs.length){
      tbody.innerHTML='<tr><td colspan="6" style="text-align:center;color:#aaa">No activity yet</td></tr>';
    } else {
      tbody.innerHTML=d.recent_logs.map(l=>{
        const cls=badgeClass[l.action]||"";
        const t=l.time?l.time.replace("T"," ").slice(0,19):"â€”";
        return `<tr>
          <td>${escHtml(t)}</td>
          <td><span class="badge ${cls}">${escHtml(l.action)}</span></td>
          <td>${escHtml(l.email)}</td>
          <td>${escHtml(l.auth)}</td>
          <td>${escHtml(l.ip||"â€”")}</td>
          <td>${escHtml(l.details)}</td>
        </tr>`;
      }).join("");
    }

    $("last-update").textContent=new Date().toLocaleTimeString();
  }catch(e){}
}

refreshStats();
setInterval(refreshStats,3000);

// â”€â”€ Users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let userPage=1;
let userQuery="";

$("user-search").addEventListener("keydown",e=>{if(e.key==="Enter")searchUsers()});

function searchUsers(){
  userQuery=$("user-search").value.trim();
  userPage=1;
  loadUsers();
}

function changePage(dir){
  userPage+=dir;
  if(userPage<1) userPage=1;
  loadUsers();
}

async function loadUsers(){
  try{
    const params=new URLSearchParams({page:userPage});
    if(userQuery) params.set("q",userQuery);
    const r=await fetch("/api/admin/users?"+params);
    if(!r.ok) return;
    const d=await r.json();

    const tbody=$("user-body");
    if(!d.users.length){
      tbody.innerHTML='<tr><td colspan="7" style="text-align:center;color:#aaa">No users found</td></tr>';
    } else {
      tbody.innerHTML=d.users.map(u=>{
        const avatar=u.avatar
          ? `<img src="${escHtml(u.avatar)}" alt="">`
          : `<div class="no-avatar">ğŸ‘¤</div>`;
        const created=u.created?u.created.replace("T"," ").slice(0,16):"â€”";
        const login=u.last_login?u.last_login.replace("T"," ").slice(0,16):"â€”";
        return `<tr>
          <td><div class="user-row">${avatar}<span>${escHtml(u.name||"â€”")}</span></div></td>
          <td>${escHtml(u.nickname||"â€”")}</td>
          <td>${escHtml(u.email)}</td>
          <td>${escHtml(u.auth)}</td>
          <td>${escHtml(created)}</td>
          <td>${escHtml(login)}</td>
          <td><button class="btn-del" onclick="showDelete(${u.id},'${escHtml(u.email)}')">Delete</button></td>
        </tr>`;
      }).join("");
    }

    const totalPages=Math.ceil(d.total/d.per_page)||1;
    $("page-info").textContent=`Page ${d.page} of ${totalPages} (${d.total} users)`;
    $("prev-page").disabled=d.page<=1;
    $("next-page").disabled=d.page>=totalPages;
  }catch(e){}
}

// â”€â”€ Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let deleteId=null;

function showDelete(id,email){
  deleteId=id;
  $("del-email").textContent=email;
  $("del-modal").classList.add("on");
}

function closeModal(){
  $("del-modal").classList.remove("on");
  deleteId=null;
}

async function confirmDelete(){
  if(!deleteId) return;
  try{
    const r=await fetch("/api/admin/users/"+deleteId,{method:"DELETE"});
    const d=await r.json();
    if(d.ok){
      closeModal();
      loadUsers();
      refreshStats();
    } else {
      alert(d.error||"Failed to delete user");
      closeModal();
    }
  }catch(e){
    alert("Network error");
    closeModal();
  }
}
</script>
</body>
</html>
